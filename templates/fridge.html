{% extends "layout.html" %}
{% block content %}

<div class="container center-page">
  <h1>ğŸ¥¬ å†·è”µåº«ã®è³å‘³æœŸé™ãƒ»æ¶ˆè²»æœŸé™ä¸€è¦§</h1>

  {% if items %}
  <table class="table" style="margin-top:12px;">
    <thead>
      <tr>
        <th>é£Ÿæå</th>
        <th>æœŸé™ã®ç¨®é¡</th>
        <th>æœŸé™æ—¥</th>
        <th>æ®‹ã‚Šæ—¥æ•°</th>
        <th>çŠ¶æ…‹</th>
      </tr>
    </thead>
    <tbody>
      {% for item in items %}
      <tr>
        <td>{{ item.name }}</td>
        <td>{{ item.expiration_type }}</td>
        <td>{{ item.expiration_date }}</td>
        <td>
          {% if item.days_left < 0 %}
            <span class="badge badge--danger">æœŸé™åˆ‡ã‚Œ</span>
          {% elif item.days_left <= 2 %}
            <span class="badge badge--warn">ã‚ã¨ {{ item.days_left }} æ—¥</span>
          {% else %}
            <span class="badge">ã‚ã¨ {{ item.days_left }} æ—¥</span>
          {% endif %}
        </td>
        <td>
          {% if item.days_left < 0 %}
            <span class="badge badge--danger">è¦å¯¾å¿œ</span>
          {% elif item.days_left <= 2 %}
            <span class="badge badge--warn">ãŠæ—©ã‚ã«</span>
          {% else %}
            <span class="badge">OK</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã‚‹é£Ÿæã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
  {% endif %}

  <div style="display:flex; justify-content:center; margin-top:18px;">
    <button class="btn btn--outline" type="button" onclick="history.back()">â¬… æˆ»ã‚‹</button>
  </div>
</div>

<!-- ã“ã“ã‹ã‚‰ä¸‹ã¯ â€œç™»éŒ²ãƒ»ä¿å­˜æ—¥æ•°è¨­å®šâ€ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€‚è¦‹ãŸç›®ã ã‘ã‚«ãƒ¼ãƒ‰åŒ– -->
<div class="container center-page">
  <h1>å†·è”µåº«ã®ä¸­èº«ä¸€è¦§</h1>

  <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card" style="margin-top:12px;">
    <form method="POST" action="{{ url_for('fridge') }}">
      <label>é£Ÿæåï¼š</label>
      <input type="text" name="name" required>

      <label style="margin-top:10px;">æœŸé™ã®ç¨®é¡ï¼š</label>
      <select name="expiration_type">
        <option value="è³å‘³æœŸé™">è³å‘³æœŸé™</option>
        <option value="æ¶ˆè²»æœŸé™">æ¶ˆè²»æœŸé™</option>
      </select>

      <label style="margin-top:10px;">æœŸé™æ—¥ï¼š</label>
      <input type="date" name="expiration_date" required>

      <button type="submit" class="btn" style="margin-top:12px;">è¿½åŠ ã™ã‚‹</button>
    </form>
  </div>

  <h2 style="margin-top:24px;">ğŸ“ é£Ÿæã”ã¨ã®ä¿å­˜æ—¥æ•°ã‚’è¨­å®š</h2>
  <div class="card" style="margin-top:8px;">
    <form id="update-days-form">
      <label>é£Ÿæåï¼š</label>
      <input type="text" id="edit-name" required>

      <label style="margin-top:10px;">ä¿å­˜æ—¥æ•°ï¼š</label>
      <input type="number" id="edit-days" required>

      <button type="submit" class="btn" style="margin-top:12px;">ä¿å­˜æ—¥æ•°ã‚’ç™»éŒ²/æ›´æ–°</button>
    </form>
    <p id="update-result" style="color:var(--brand-700); font-weight:700; margin-top:10px;"></p>

    <h3 style="margin-top:10px;">ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ä¿å­˜æ—¥æ•°ä¸€è¦§</h3>
    <div id="storage-days-list"></div>
  </div>
</div>

{% block scripts %}
<script>
  let storageDays = {};

  async function loadStorageDays() {
    const res = await fetch('/get_storage_days');
    const data = await res.json();
    storageDays = data;
  }

  async function renderStorageDaysList() {
    const container = document.getElementById("storage-days-list");
    if (!storageDays || Object.keys(storageDays).length === 0) {
      container.innerHTML = "<p>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ä¿å­˜æ—¥æ•°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
      return;
    }
    let html = "<ul>";
    for (const [name, days] of Object.entries(storageDays)) {
      html += `<li><strong>${name}</strong>ï¼š${days}æ—¥</li>`;
    }
    html += "</ul>";
    container.innerHTML = html;
  }

  async function setupAutoFill() {
    await loadStorageDays();
    await renderStorageDaysList();

    const nameInput = document.querySelector('input[name="name"]');
    const expirationInput = document.querySelector('input[name="expiration_date"]');

    if (nameInput && expirationInput) {
      nameInput.addEventListener("change", function() {
        const name = this.value.trim();
        const today = new Date();
        if (storageDays[name]) {
          const daysToAdd = storageDays[name];
          const expirationDate = new Date(today);
          expirationDate.setDate(today.getDate() + daysToAdd);
          const yyyy = expirationDate.getFullYear();
          const mm = String(expirationDate.getMonth() + 1).padStart(2, '0');
          const dd = String(expirationDate.getDate()).padStart(2, '0');
          expirationInput.value = `${yyyy}-${mm}-${dd}`;
        }
      });
    }
  }

  document.getElementById("update-days-form")?.addEventListener("submit", async function(e) {
    e.preventDefault();
    const name = document.getElementById("edit-name").value.trim();
    const days = parseInt(document.getElementById("edit-days").value);
    if (!name || isNaN(days)) return;

    const res = await fetch('/update_storage_day', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name, days})
    });

    if (res.ok) {
      document.getElementById("update-result").textContent =
        `âœ… ã€Œ${name}ã€ã®ä¿å­˜æ—¥æ•°ã‚’${days}æ—¥ã«è¨­å®šã—ã¾ã—ãŸã€‚`;
      await loadStorageDays();
      await renderStorageDaysList();
    } else {
      document.getElementById("update-result").textContent = `âš  ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`;
    }
  });

  window.onload = setupAutoFill;
</script>
{% endblock %}

{% endblock %}

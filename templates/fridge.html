{% extends "layout.html" %}
{% block content %}
<div class="container">
    <h1 style="text-align:center; color:#4caf50;">ğŸ¥¬ å†·è”µåº«ã®è³å‘³æœŸé™ãƒ»æ¶ˆè²»æœŸé™ä¸€è¦§</h1>

    {% if items %}
        <table style="width:100%; margin-top:30px; border-collapse: collapse; font-size:18px;">
            <thead>
                <tr style="background-color:#a5d6a7;">
                    <th style="padding:12px; border:1px solid #ccc;">é£Ÿæå</th>
                    <th style="padding:12px; border:1px solid #ccc;">æœŸé™ã®ç¨®é¡</th>
                    <th style="padding:12px; border:1px solid #ccc;">æœŸé™æ—¥</th>
                    <th style="padding:12px; border:1px solid #ccc;">æ®‹ã‚Šæ—¥æ•°</th>
                    <th style="padding:12px; border:1px solid #ccc;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr style="background-color: {% if item.expiration_type == 'æ¶ˆè²»æœŸé™' %}#ffccbc{% else %}#e8f5e9{% endif %};">
                    <td style="padding:10px; border:1px solid #ccc;">{{ item.name }}</td>
                    <td style="padding:10px; border:1px solid #ccc;">{{ item.expiration_type }}</td>
                    <td style="padding:10px; border:1px solid #ccc;">{{ item.expiration_date }}</td>
                    <td style="padding:10px; border:1px solid #ccc;">
                        {% if item.days_left < 0 %}
                            <span style="color:red;">æœŸé™åˆ‡ã‚Œ</span>
                        {% else %}
                            ã‚ã¨ {{ item.days_left }} æ—¥
                        {% endif %}
                    </td>
               
                <td style="padding:10px; border:1px solid #ccc;">
                    {% if item.days_left < 0 %}
                        <span style="color:red; font-weight:bold;">æœŸé™åˆ‡ã‚Œ</span>
                    {% elif item.days_left <= 2 %}
                        <span style="color:orange; font-weight:bold;">ã‚ã¨ {{ item.days_left }} æ—¥</span>
                    {% else %}
                        ã‚ã¨ {{ item.days_left }} æ—¥
                    {% endif %}
                </td>

                </tr>
                
                {% endfor %}
            </tbody>

        </table>
    {% else %}
        <p>ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã‚‹é£Ÿæã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}

    <div style="text-align:center; margin-top:30px;">
        <a href="{{ url_for('index') }}" class="recipe-button">â¬… æˆ»ã‚‹</a>
    </div>
</div>


<h1>å†·è”µåº«ã®ä¸­èº«ä¸€è¦§</h1>

<!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
<form method="POST" action="{{ url_for('fridge') }}">
  <label>é£Ÿæåï¼š</label>
  <input type="text" name="name" required><br>

  <label>æœŸé™ã®ç¨®é¡ï¼š</label>
  <select name="expiration_type">
    <option value="è³å‘³æœŸé™">è³å‘³æœŸé™</option>
    <option value="æ¶ˆè²»æœŸé™">æ¶ˆè²»æœŸé™</option>
  </select><br>

  <label>æœŸé™æ—¥ï¼š</label>
  <input type="date" name="expiration_date" required><br>

  <button type="submit">è¿½åŠ ã™ã‚‹</button>
</form>

<h2>ğŸ“ é£Ÿæã”ã¨ã®ä¿å­˜æ—¥æ•°ã‚’è¨­å®š</h2>
<form id="update-days-form">
  <label>é£Ÿæåï¼š</label>
  <input type="text" id="edit-name" required><br>

  <label>ä¿å­˜æ—¥æ•°ï¼š</label>
  <input type="number" id="edit-days" required><br>

  <button type="submit">ä¿å­˜æ—¥æ•°ã‚’ç™»éŒ²/æ›´æ–°</button>
</form>

<p id="update-result" style="color:green;"></p>

<h3>ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ä¿å­˜æ—¥æ•°ä¸€è¦§</h3>
<div id="storage-days-list"></div>


<script>
  let storageDays = {};

  // ä¿å­˜æ—¥æ•°ã‚’å–å¾—ã—ã¦ storageDays ã«åæ˜ 
  async function loadStorageDays() {
    const res = await fetch('/get_storage_days');
    const data = await res.json();
    storageDays = data;
  }

  async function renderStorageDaysList() {
    const container = document.getElementById("storage-days-list");
    if (!storageDays || Object.keys(storageDays).length === 0) {
      container.innerHTML = "<p>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ä¿å­˜æ—¥æ•°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
      return;
    }

    let html = "<ul>";
    for (const [name, days] of Object.entries(storageDays)) {
      html += `<li><strong>${name}</strong>ï¼š${days}æ—¥</li>`;
    }
    html += "</ul>";
    container.innerHTML = html;
  }

  // ä¿å­˜æ—¥æ•°ã‚’é£Ÿæåå…¥åŠ›æ™‚ã«ä½¿ã£ã¦æ—¥ä»˜è‡ªå‹•å…¥åŠ›
  async function setupAutoFill() {
    await loadStorageDays();
    await renderStorageDaysList();

    const nameInput = document.querySelector('input[name="name"]');
    const expirationInput = document.querySelector('input[name="expiration_date"]');

    nameInput.addEventListener("change", function() {
      const name = this.value.trim();
      const today = new Date();

      if (storageDays[name]) {
        const daysToAdd = storageDays[name];
        const expirationDate = new Date(today);
        expirationDate.setDate(today.getDate() + daysToAdd);

        const yyyy = expirationDate.getFullYear();
        const mm = String(expirationDate.getMonth() + 1).padStart(2, '0');
        const dd = String(expirationDate.getDate()).padStart(2, '0');
        expirationInput.value = `${yyyy}-${mm}-${dd}`;
      }
    });
  }

  // ä¿å­˜æ—¥æ•°ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
  document.getElementById("update-days-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const name = document.getElementById("edit-name").value.trim();
    const days = parseInt(document.getElementById("edit-days").value);

    if (!name || isNaN(days)) return;

    const res = await fetch('/update_storage_day', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name, days})
    });

    if (res.ok) {
      document.getElementById("update-result").textContent = `âœ… ã€Œ${name}ã€ã®ä¿å­˜æ—¥æ•°ã‚’${days}æ—¥ã«è¨­å®šã—ã¾ã—ãŸã€‚`;
      await loadStorageDays();  // åæ˜ 
      await renderStorageDaysList(); 
    } else {
      document.getElementById("update-result").textContent = `âš  ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`;
    }
  });

  window.onload = setupAutoFill;
</script>




{% endblock %}
